name: IPQ60XX-Immortalwrt

on:
  workflow_run:
    workflows: ["Auto-Clean"]
    types:
      - completed
  workflow_dispatch:

jobs:
  Build:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        repo:
          - { url: "https://github.com/VIKINGYFY/immortalwrt.git", branch: "main", tag: "immortalwrt-main" }
          - { url: "https://github.com/laipeng668/openwrt-6.x.git", branch: "k6.12-nss", tag: "openwrt-k6.12-nss" }

    env:
      CONFIG_FILE: configs/IPQ60XX.config
      GENERAL_CONFIG_FILE: configs/General.config
      DIY_SCRIPT: scripts/Roc-script.sh
      CLASH_KERNEL: amd64
      UPLOAD_BIN_DIR: false
      FIRMWARE_RELEASE: true
      FIRMWARE_TAG: IPQ60XX
      TZ: Asia/Shanghai

    steps:
    - name: Checkout
      uses: actions/checkout@main

    - name: Init Env
      run: |
        sudo -E apt-get -y update
        sudo -E apt-get -y install $(curl -fsSL is.gd/depends_ubuntu_2204)
        sudo timedatectl set-timezone "$TZ"

    - name: Clone Source
      run: |
        sudo mkdir -p /mnt/openwrt
        sudo chown -R $(id -u):$(id -g) /mnt/openwrt
        git clone --depth 1 -b ${{ matrix.repo.branch }} ${{ matrix.repo.url }} /mnt/openwrt
        cd /mnt/openwrt
        echo "OPENWRT_PATH=$PWD" >> $GITHUB_ENV
        VERSION_INFO=$(git show -s --date=short --format="作者: %an<br/>时间: %cd<br/>内容: %s<br/>hash: %H")
        echo "VERSION_INFO=$VERSION_INFO" >> $GITHUB_ENV
        VERSION_KERNEL=$(grep -oP 'LINUX_KERNEL_HASH-\K[0-9]+\.[0-9]+\.[0-9]+' target/linux/generic/kernel-6.12 || true)
        echo "VERSION_KERNEL=$VERSION_KERNEL" >> $GITHUB_ENV

    - name: Feeds
      run: |
        cd $OPENWRT_PATH
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Load Config
      run: |
        chmod +x $DIY_SCRIPT
        cd $OPENWRT_PATH
        $GITHUB_WORKSPACE/$DIY_SCRIPT
        cat $CONFIG_FILE $GENERAL_CONFIG_FILE > .config
        make defconfig

    - name: Download Packages
      run: |
        cd $OPENWRT_PATH
        make download -j$(nproc)

    - name: Compile
      id: compile
      run: |
        cd $OPENWRT_PATH
        make -j$(nproc) || make -j1 V=s
        echo "status=success" >> $GITHUB_OUTPUT
        echo "DATE=$(date +"%Y-%m-%d %H:%M:%S")" >> $GITHUB_ENV
        echo "FILE_DATE=$(date +"%Y.%m.%d")" >> $GITHUB_ENV

    - name: Organize Files
      if: steps.compile.outputs.status == 'success'
      run: |
        cd $OPENWRT_PATH/bin/targets/*/*
        mkdir publish
        cp *-factory.bin publish/ || true
        cp *-sysupgrade.bin publish/ || true
        # 生成 SHA256 校验文件
        (cd publish && sha256sum * > SHA256SUMS)
        echo "FIRMWARE_PATH=$PWD/publish" >> $GITHUB_ENV

    - name: Upload Firmware To Release
      if: steps.compile.outputs.status == 'success' && env.FIRMWARE_RELEASE == 'true'
      uses: ncipollo/release-action@main
      with:
        name: ${{ env.DATE }} for ${{ env.FIRMWARE_TAG }}-${{ matrix.repo.tag }}
        allowUpdates: true
        tag: ${{ env.FIRMWARE_TAG }}-${{ matrix.repo.tag }}
        token: ${{ secrets.GITHUB_TOKEN }}
        artifacts: ${{ env.FIRMWARE_PATH }}/*
        body: |
          **This is OpenWrt Firmware for ${{ env.FIRMWARE_TAG }}**
          ### 📒 固件信息
          - 仅包含 factory.bin 和 sysupgrade.bin
          - 💻 平台: ${{ env.FIRMWARE_TAG }}
          - ⚽ 源码: ${{ matrix.repo.url }}
          - 💝 分支: ${{ matrix.repo.branch }}
          - 🌐 默认地址: **192.168.2.1**
          - 🔑 默认密码: none
          ### 🧊 固件版本
          - 内核版本：**${{ env.VERSION_KERNEL }}**
          - 源码更新记录：
          - ${{ env.VERSION_INFO }}
